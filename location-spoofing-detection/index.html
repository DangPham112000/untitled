<!-- Dang Pham -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="./style.css" />
        <title>Location Spoofing Detection</title>
    </head>

    <body>
        <button class="btn-76" onclick="go()">
            Request
            <span class="top"></span>
            <span class="right"></span>
            <span class="bottom"></span>
            <span class="left"></span>
        </button>
        <button class="btn-76" onclick="stop()">
            Stop
            <span class="top"></span>
            <span class="right"></span>
            <span class="bottom"></span>
            <span class="left"></span>
        </button>
        <div id="log"></div>
        <script type="text/javascript">
            var intervalId = null;
            function go() {
                var varCounter = 0;
                var varName = function () {
                    if (varCounter <= 999) {
                        varCounter++;
                        test();
                    } else {
                        clearInterval(intervalId);
                    }
                };
                intervalId = setInterval(varName, 700);
            }

            function stop() {
                clearInterval(intervalId);
            }

            function log(e) {
                document.getElementById("log").innerHTML += e + "</br>";
            }

            function test() {
                spoofingDetection.detect(function (spoofed, description) {
                    log(`[${spoofed}] ${description}`);
                });
            }

            /*
    Returns
        * spoofed
            1: spoofed for sure
            empty: not sure if spoofed or not
        * description

    Logics
    - Not chromium nor firefox
        {spoofed: '', 'Browser is not supported'}
    - No permission API
        {spoofed: '', 'Can not detect because browser does not support permission API'}
    - Permission prompt
        {spoofed: '', 'Can not detect due to permission status'}
    - Permission granted
        Geolocate 25 times with
            - timeout: 10ms
            - maximumAge: 0 (on chromium) / 1 (firefox)
        Spoofing check
            - chromium: gt 80% res time < 10
            - firefox: gt 50% res time < 2 AND lt 30% res time > 3

    */
            var spoofingDetection = (function () {
                var hasPermissionAPI = "permissions" in navigator,
                    isChromium = !!window.chrome;
                var TIMEOUT = 10,
                    MAX_AGE = 0,
                    LIMIT = 25;
                var count = 0;
                var duration = [];
                var timeoutCount = 0,
                    deniedCount = 0;

                function getLocation(done) {
                    navigator.geolocation.getCurrentPosition(
                        function (e) {
                            console.log(
                                "===>> ok ",
                                e.coords.latitude,
                                e.coords.longitude,
                                e.coords.accuracy
                            );
                            done();
                        },
                        function (err) {
                            console.log("===>> err ", err);
                            if (err.code === err.TIMEOUT) {
                                timeoutCount++;
                            } else if (err.code === err.PERMISSION_DENIED) {
                                deniedCount++;
                            }
                            done();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: TIMEOUT,
                            maximumAge: MAX_AGE,
                        }
                    );
                }

                function detect(cb) {
                    timeoutCount = 0;
                    deniedCount = 0;
                    if (!isChromium) {
                        return cb("", "Browser is not supported");
                    }
                    if (!hasPermissionAPI) {
                        return cb(
                            "",
                            "Can not detect because browser does not support permission API"
                        );
                    }
                    count = 0;
                    duration = [];
                    check(cb);
                }

                function check(cb) {
                    var start = +new Date();
                    console.log(`${count} ${start}`);
                    if (count < LIMIT) {
                        getLocation(function () {
                            count++;
                            duration.push(new Date() - start);
                            setTimeout(function () {
                                check(cb);
                            }, 0);
                        });
                    } else {
                        var totalTime = 0;
                        for (var i = 0; i < duration.length; i++) {
                            totalTime += duration[i];
                        }
                        var durationStr = duration.join(
                            "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
                        );
                        var matches = duration.filter(
                                (x) => x < TIMEOUT
                            ).length,
                            tooFast = matches / LIMIT > 0.8,
                            spoofed =
                                (tooFast || timeoutCount === 0) &&
                                deniedCount < LIMIT;
                        //chrome + ethernet cable
                        if (spoofed && totalTime > LIMIT * 1.5) {
                            spoofed = false;
                        }
                        return cb(
                            spoofed ? 1 : "",
                            `${durationStr} &nbsp;&nbsp;&nbsp;&nbsp; ==> ${matches} of ${duration.length} matched & timeout = ${timeoutCount} & denied = ${deniedCount} & duration = ${totalTime} ==> spoofed =  ${spoofed}`
                        );
                    }
                }

                return {
                    detect: detect,
                };
            })();
        </script>
    </body>
</html>
